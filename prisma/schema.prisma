// Schema Prisma per Sales Support App
// CRM per agenzia di web marketing

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// LEAD - Dati da Google Maps + Audit + CRM
// ==========================================
model Lead {
  id        String   @id @default(uuid())

  // Dati da Google Maps (Apify)
  name              String
  address           String?
  phone             String?
  website           String?
  category          String?
  googleRating      Decimal?  @map("google_rating") @db.Decimal(2, 1)
  googleReviewsCount Int?     @map("google_reviews_count")
  googleMapsUrl     String?   @map("google_maps_url")
  placeId           String?   @unique @map("place_id")

  // Risultato Audit
  auditStatus       AuditStatus @default(PENDING) @map("audit_status")
  auditCompletedAt  DateTime?   @map("audit_completed_at")
  opportunityScore  Int?        @map("opportunity_score")

  // Audit details (JSON per flessibilita)
  auditData         Json?       @map("audit_data")

  // Talking points generati
  talkingPoints     String[]    @map("talking_points")

  // ==========================================
  // SEGNALI COMMERCIALI (Sistema 5 chiamate/giorno)
  // ==========================================
  // Tag commerciale obbligatorio (1 solo per lead)
  commercialTag     CommercialTag?  @map("commercial_tag")
  commercialTagReason String?       @map("commercial_tag_reason")

  // I 5 segnali commerciali (JSON)
  commercialSignals Json?           @map("commercial_signals")
  /*
    {
      "adsEvidence": "strong" | "medium" | "weak" | "none",
      "adsEvidenceReason": "...",
      "trackingPresent": true | false,
      "consentModeV2": "yes" | "no" | "uncertain",
      "ctaClear": true | false,
      "offerFocused": true | false,
      "analyzedAt": "ISO date",
      "errors": ["..."] // opzionale
    }
  */

  // Priorita commerciale (1=alta, 4=skip)
  commercialPriority Int?           @map("commercial_priority")

  // Flag per dashboard "Chiamabili oggi"
  isCallable        Boolean         @default(false) @map("is_callable")

  // CRM Pipeline
  pipelineStage     PipelineStage @default(NEW) @map("pipeline_stage")
  lostReason        String?       @map("lost_reason")

  // ==========================================
  // CRM MINIMALE per logging chiamate rapido
  // ==========================================
  // Ultimo esito chiamata
  lastCallOutcome   CallOutcome?  @map("last_call_outcome")
  lastCallNotes     String?       @map("last_call_notes")

  // Obiezione principale (per tracking pattern)
  mainObjection     Objection?    @map("main_objection")
  objectionNotes    String?       @map("objection_notes")

  // Next step (pianificazione follow-up)
  nextStepType      NextStepType? @map("next_step_type")
  nextStepNotes     String?       @map("next_step_notes")

  // Activity tracking
  lastContactedAt   DateTime?   @map("last_contacted_at")
  nextFollowupAt    DateTime?   @map("next_followup_at")
  assignedTo        String?     @map("assigned_to")

  // Metadata
  source            String      @default("google_maps")
  notes             String?
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relazioni
  searchId          String?     @map("search_id")
  search            Search?     @relation(fields: [searchId], references: [id])
  activities        Activity[]
  tasks             Task[]

  @@index([opportunityScore(sort: Desc)], name: "idx_leads_score")
  @@index([pipelineStage], name: "idx_leads_stage")
  @@index([auditStatus], name: "idx_leads_audit_status")
  // Indici per sistema commerciale
  @@index([commercialTag], name: "idx_leads_commercial_tag")
  @@index([commercialPriority], name: "idx_leads_commercial_priority")
  @@index([isCallable], name: "idx_leads_callable")
  @@map("leads")
}

// ==========================================
// ACTIVITY - Storico attivita sul lead
// ==========================================
model Activity {
  id        String   @id @default(uuid())

  type      ActivityType
  outcome   CallOutcome?
  notes     String?
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  // Relazione
  leadId    String   @map("lead_id")
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId], name: "idx_activities_lead")
  @@map("activities")
}

// ==========================================
// SEARCH - Ricerche salvate
// ==========================================
model Search {
  id              String       @id @default(uuid())

  query           String       // es. "Ristoranti"
  location        String       // es. "Milano centro"
  apifyRunId      String?      @map("apify_run_id")
  status          SearchStatus @default(PENDING)
  leadsFound      Int          @default(0) @map("leads_found")
  leadsWithWebsite Int         @default(0) @map("leads_with_website")
  errorMessage    String?      @map("error_message")
  createdAt       DateTime     @default(now()) @map("created_at")
  completedAt     DateTime?    @map("completed_at")

  // Relazione
  leads           Lead[]

  @@map("searches")
}

// ==========================================
// TASK - Reminder e follow-up
// ==========================================
model Task {
  id          String    @id @default(uuid())

  title       String
  description String?
  dueAt       DateTime? @map("due_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relazione
  leadId      String    @map("lead_id")
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([dueAt], name: "idx_tasks_due")
  @@map("tasks")
}

// ==========================================
// USER - Per autenticazione
// ==========================================
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String    // Hash bcrypt
  name          String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

// ==========================================
// ENUMS
// ==========================================

enum AuditStatus {
  PENDING     // In attesa
  RUNNING     // In analisi
  COMPLETED   // Completato
  FAILED      // Errore
  NO_WEBSITE  // Nessun sito web
  TIMEOUT     // Timeout
}

enum PipelineStage {
  NEW           // Nuovo
  TO_CALL       // Da chiamare
  CALLED        // Chiamato
  INTERESTED    // Interessato
  AUDIT_SENT    // Audit inviato
  MEETING       // Call/Meeting fissato
  PROPOSAL      // Preventivo inviato
  WON           // Chiuso vinto
  LOST          // Chiuso perso
}

enum ActivityType {
  CALL          // Chiamata
  NOTE          // Nota
  EMAIL_SENT    // Email inviata
  MEETING       // Meeting
  PROPOSAL_SENT // Preventivo inviato
  STAGE_CHANGE  // Cambio stato
}

enum CallOutcome {
  ANSWERED        // Risposto
  NO_ANSWER       // Non risponde
  BUSY            // Occupato
  NOT_INTERESTED  // Non interessato
  CALLBACK        // Richiamare
  INTERESTED      // Interessato
}

enum SearchStatus {
  PENDING     // In attesa
  RUNNING     // In esecuzione
  COMPLETED   // Completata
  FAILED      // Fallita
}

enum CommercialTag {
  ADS_ATTIVE_CONTROLLO_ASSENTE    // Spendono ma non misurano - PRIORITA 1
  TRAFFICO_SENZA_DIREZIONE        // Traffico ma niente CTA - PRIORITA 2
  STRUTTURA_OK_NON_PRIORITIZZATA  // Funziona ma non ottimizzato - PRIORITA 3
  NON_TARGET                      // Non spendono in ads - SKIP
}

// Obiezioni comuni durante le chiamate
enum Objection {
  BUDGET              // "Non abbiamo budget"
  TIMING              // "Non e' il momento giusto"
  ALREADY_HAVE        // "Abbiamo gia qualcuno che ci segue"
  NOT_INTERESTED      // "Non ci interessa"
  NEED_TO_THINK       // "Devo pensarci"
  DECISION_MAKER      // "Devo parlare con..."
  BAD_EXPERIENCE      // "Abbiamo avuto brutte esperienze"
  NO_NEED             // "Non ne abbiamo bisogno"
  OTHER               // Altro (specificare in notes)
}

// Tipi di next step
enum NextStepType {
  CALLBACK            // Richiamare
  SEND_INFO           // Inviare materiale
  MEETING             // Fissare meeting
  PROPOSAL            // Inviare preventivo
  WAIT                // Aspettare (loro richiameranno)
  CLOSE               // Chiudere (vinto o perso)
}

enum UserRole {
  ADMIN
  USER
}

// ==========================================
// SEARCH CONFIG - Configurazione ricerche
// ==========================================
model SearchCategory {
  id        String   @id @default(uuid())
  label     String   @unique
  icon      String   @default("üè¢")
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("search_categories")
}

model SearchLocation {
  id        String   @id @default(uuid())
  name      String   @unique
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("search_locations")
}
