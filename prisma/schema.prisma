// Schema Prisma per Sales Support App
// CRM per agenzia di web marketing

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// LEAD - Dati da Google Maps + Audit + CRM
// ==========================================
model Lead {
  id        String   @id @default(uuid())

  // Dati da Google Maps (Apify)
  name              String
  address           String?
  phone             String?
  website           String?
  category          String?
  googleRating      Decimal?  @map("google_rating") @db.Decimal(2, 1)
  googleReviewsCount Int?     @map("google_reviews_count")
  googleMapsUrl     String?   @map("google_maps_url")
  placeId           String?   @unique @map("place_id")

  // Risultato Audit
  auditStatus       AuditStatus @default(PENDING) @map("audit_status")
  auditCompletedAt  DateTime?   @map("audit_completed_at")
  opportunityScore  Int?        @map("opportunity_score")

  // Audit details (JSON per flessibilita)
  auditData         Json?       @map("audit_data")

  // Talking points generati
  talkingPoints     String[]    @map("talking_points")

  // ==========================================
  // SEGNALI COMMERCIALI (Sistema 5 chiamate/giorno)
  // ==========================================
  // Tag commerciale obbligatorio (1 solo per lead)
  commercialTag     CommercialTag?  @map("commercial_tag")
  commercialTagReason String?       @map("commercial_tag_reason")

  // I 5 segnali commerciali (JSON)
  commercialSignals Json?           @map("commercial_signals")
  /*
    {
      "adsEvidence": "strong" | "medium" | "weak" | "none",
      "adsEvidenceReason": "...",
      "trackingPresent": true | false,
      "consentModeV2": "yes" | "no" | "uncertain",
      "ctaClear": true | false,
      "offerFocused": true | false,
      "analyzedAt": "ISO date",
      "errors": ["..."] // opzionale
    }
  */

  // Priorita commerciale (1=alta, 4=skip)
  commercialPriority Int?           @map("commercial_priority")

  // Flag per dashboard "Chiamabili oggi"
  isCallable        Boolean         @default(false) @map("is_callable")

  // CRM Pipeline MSD
  pipelineStage     PipelineStage @default(NEW) @map("pipeline_stage")
  lostReason        LostReason?   @map("lost_reason")
  lostReasonNotes   String?       @map("lost_reason_notes")

  // Contatore tentativi chiamata (per NON_RISPONDE, max 3)
  callAttempts      Int           @default(0) @map("call_attempts")

  // Data/ora appuntamento (per CALL_FISSATA)
  appointmentAt     DateTime?     @map("appointment_at")

  // Data invio offerta (per calcolo 20gg ghost)
  offerSentAt       DateTime?     @map("offer_sent_at")

  // ==========================================
  // CRM MINIMALE per logging chiamate rapido
  // ==========================================
  // Ultimo esito chiamata
  lastCallOutcome   CallOutcome?  @map("last_call_outcome")
  lastCallNotes     String?       @map("last_call_notes")

  // Obiezione principale (per tracking pattern)
  mainObjection     Objection?    @map("main_objection")
  objectionNotes    String?       @map("objection_notes")

  // Next step (pianificazione follow-up)
  nextStepType      NextStepType? @map("next_step_type")
  nextStepNotes     String?       @map("next_step_notes")

  // Activity tracking
  lastContactedAt   DateTime?   @map("last_contacted_at")
  nextFollowupAt    DateTime?   @map("next_followup_at")
  assignedTo        String?     @map("assigned_to")

  // Verifica audit (checklist di Daniela)
  auditVerified           Boolean   @default(false) @map("audit_verified")
  auditVerifiedAt         DateTime? @map("audit_verified_at")
  auditVerifiedBy         String?   @map("audit_verified_by")
  auditVerificationChecks Json?     @map("audit_verification_checks")

  // Metadata
  source            String      @default("google_maps")
  notes             String?
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relazioni
  searchId          String?     @map("search_id")
  search            Search?     @relation(fields: [searchId], references: [id])
  activities        Activity[]
  tasks             Task[]

  @@index([opportunityScore(sort: Desc)], name: "idx_leads_score")
  @@index([pipelineStage], name: "idx_leads_stage")
  @@index([auditStatus], name: "idx_leads_audit_status")
  // Indici per sistema commerciale
  @@index([commercialTag], name: "idx_leads_commercial_tag")
  @@index([commercialPriority], name: "idx_leads_commercial_priority")
  @@index([isCallable], name: "idx_leads_callable")
  // Indici per pipeline MSD
  @@index([appointmentAt], name: "idx_leads_appointment")
  @@index([offerSentAt], name: "idx_leads_offer_sent")
  @@index([nextFollowupAt], name: "idx_leads_followup")
  @@map("leads")
}

// ==========================================
// ACTIVITY - Storico attivita sul lead
// ==========================================
model Activity {
  id        String   @id @default(uuid())

  type      ActivityType
  outcome   CallOutcome?
  notes     String?
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  // Relazione
  leadId    String   @map("lead_id")
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId], name: "idx_activities_lead")
  @@map("activities")
}

// ==========================================
// SEARCH - Ricerche salvate
// ==========================================
model Search {
  id              String       @id @default(uuid())

  query           String       // es. "Ristoranti"
  location        String       // es. "Milano centro"
  apifyRunId      String?      @map("apify_run_id")
  status          SearchStatus @default(PENDING)
  leadsFound      Int          @default(0) @map("leads_found")
  leadsWithWebsite Int         @default(0) @map("leads_with_website")
  errorMessage    String?      @map("error_message")
  createdAt       DateTime     @default(now()) @map("created_at")
  completedAt     DateTime?    @map("completed_at")

  // Relazione
  leads           Lead[]

  @@map("searches")
}

// ==========================================
// TASK - Reminder e follow-up
// ==========================================
model Task {
  id          String    @id @default(uuid())

  title       String
  description String?
  dueAt       DateTime? @map("due_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relazione
  leadId      String    @map("lead_id")
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([dueAt], name: "idx_tasks_due")
  @@map("tasks")
}

// ==========================================
// USER - Per autenticazione
// ==========================================
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String    // Hash bcrypt
  name          String?
  role          UserRole  @default(USER)
  twoFactorEnabled Boolean @default(false) @map("two_factor_enabled")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relazioni
  otpCodes      OtpCode[]
  passwordResets PasswordReset[]

  @@map("users")
}

// ==========================================
// OTP CODE - Codici per autenticazione 2FA
// ==========================================
model OtpCode {
  id        String   @id @default(uuid())
  code      String   // Codice OTP a 6 cifre (hashed)
  email     String   // Email destinatario
  type      OtpType  @default(TWO_FACTOR) // Tipo di OTP
  expiresAt DateTime @map("expires_at") // Scadenza (10 minuti)
  used      Boolean  @default(false) // Se gi√† utilizzato
  attempts  Int      @default(0) // Tentativi di verifica
  createdAt DateTime @default(now()) @map("created_at")

  // Relazione con utente
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, type], name: "idx_otp_email_type")
  @@index([expiresAt], name: "idx_otp_expires")
  @@map("otp_codes")
}

// ==========================================
// PASSWORD RESET - Token per recupero password
// ==========================================
model PasswordReset {
  id        String   @id @default(uuid())
  token     String   @unique // Token univoco (hashed)
  email     String   // Email utente
  expiresAt DateTime @map("expires_at") // Scadenza (1 ora)
  used      Boolean  @default(false) // Se gi√† utilizzato
  createdAt DateTime @default(now()) @map("created_at")

  // Relazione con utente
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email], name: "idx_password_reset_email")
  @@index([expiresAt], name: "idx_password_reset_expires")
  @@map("password_resets")
}

// ==========================================
// ENUMS
// ==========================================

enum AuditStatus {
  PENDING     // In attesa
  RUNNING     // In analisi
  COMPLETED   // Completato
  FAILED      // Errore
  NO_WEBSITE  // Nessun sito web
  TIMEOUT     // Timeout
}

// ==========================================
// PIPELINE VENDITA MSD
// ==========================================
enum PipelineStage {
  // === SELEZIONE (pre-chiamata) ===
  NEW             // Appena importato, audit in corso
  DA_CHIAMARE     // Score > soglia, pronto per chiamata
  DA_VERIFICARE   // Tag DA_APPROFONDIRE, verifica manuale
  NON_TARGET      // Nessun segnale ads (rivedibile)
  SENZA_SITO      // No website (archivio morto)

  // === VENDITA MSD (post-chiamata) ===
  NON_RISPONDE    // Tentativo fallito (max 3)
  RICHIAMARE      // Ha chiesto di richiamare (data X)
  CALL_FISSATA    // Appuntamento vendita fissato
  NON_PRESENTATO  // Ghost alla call vendita
  OFFERTA_INVIATA // In attesa pagamento 600‚Ç¨
  VINTO           // Ha pagato - Cliente MSD
  PERSO           // Chiuso negativo
}

// Motivi per cui un lead e' stato perso
enum LostReason {
  NO_INTERESSE    // Non gli interessa (in chiamata)
  NO_BUDGET       // Non ha budget
  GHOST_CALL      // Non si presenta e sparisce
  GHOST_OFFERTA   // Non paga dopo 20gg
  COMPETITOR      // Ha scelto un competitor
  TEMPISTICA      // Non e' il momento giusto
  ALTRO           // Altro (specificare in notes)
}

enum ActivityType {
  CALL          // Chiamata
  NOTE          // Nota
  EMAIL_SENT    // Email inviata
  MEETING       // Meeting
  PROPOSAL_SENT // Preventivo inviato
  STAGE_CHANGE  // Cambio stato
}

enum CallOutcome {
  ANSWERED        // Risposto
  NO_ANSWER       // Non risponde
  BUSY            // Occupato
  NOT_INTERESTED  // Non interessato
  CALLBACK        // Richiamare
  INTERESTED      // Interessato
}

enum SearchStatus {
  PENDING     // In attesa
  RUNNING     // In esecuzione
  COMPLETED   // Completata
  FAILED      // Fallita
}

enum CommercialTag {
  ADS_ATTIVE_CONTROLLO_ASSENTE    // Spendono ma non misurano - PRIORITA 1
  TRAFFICO_SENZA_DIREZIONE        // Traffico ma niente CTA - PRIORITA 2
  STRUTTURA_OK_NON_PRIORITIZZATA  // Funziona ma non ottimizzato - PRIORITA 3
  DA_APPROFONDIRE                 // Ha GTM/tracking ma non chiaro se fa ads - PRIORITA 3
  NON_TARGET                      // Non spendono in ads - SKIP
}

// Obiezioni comuni durante le chiamate
enum Objection {
  BUDGET              // "Non abbiamo budget"
  TIMING              // "Non e' il momento giusto"
  ALREADY_HAVE        // "Abbiamo gia qualcuno che ci segue"
  NOT_INTERESTED      // "Non ci interessa"
  NEED_TO_THINK       // "Devo pensarci"
  DECISION_MAKER      // "Devo parlare con..."
  BAD_EXPERIENCE      // "Abbiamo avuto brutte esperienze"
  NO_NEED             // "Non ne abbiamo bisogno"
  OTHER               // Altro (specificare in notes)
}

// Tipi di next step
enum NextStepType {
  CALLBACK            // Richiamare
  SEND_INFO           // Inviare materiale
  MEETING             // Fissare meeting
  PROPOSAL            // Inviare preventivo
  WAIT                // Aspettare (loro richiameranno)
  CLOSE               // Chiudere (vinto o perso)
}

enum UserRole {
  ADMIN
  USER
}

enum OtpType {
  TWO_FACTOR      // 2FA al login
  PASSWORD_RESET  // Reset password
}

// ==========================================
// SEARCH CONFIG - Configurazione ricerche
// ==========================================
model SearchCategory {
  id        String   @id @default(uuid())
  label     String   @unique
  icon      String   @default("üè¢")
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("search_categories")
}

model SearchLocation {
  id        String   @id @default(uuid())
  name      String   @unique
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("search_locations")
}

// ==========================================
// SETTINGS - Configurazioni app
// ==========================================
model Settings {
  id        String   @id @default("default")

  // Soglia score per "Da chiamare oggi" (default 60)
  scoreThreshold    Int      @default(60) @map("score_threshold")

  // Limite chiamate giornaliere (default 5)
  dailyCallLimit    Int      @default(5) @map("daily_call_limit")

  // Giorni dopo offerta per considerare ghost (default 20)
  ghostOfferDays    Int      @default(20) @map("ghost_offer_days")

  // Max tentativi chiamata prima di considerare perso (default 3)
  maxCallAttempts   Int      @default(3) @map("max_call_attempts")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
